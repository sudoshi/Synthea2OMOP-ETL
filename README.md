# Synthea2OMOP-ETL

A comprehensive ETL (Extract, Transform, Load) pipeline for converting Synthea synthetic patient data to OMOP Common Data Model (CDM) format.

## Project Overview

This project provides a streamlined and optimized pipeline for transforming synthetic patient data generated by the Synthea tool into the OMOP Common Data Model format, making it suitable for use with OHDSI tools and analytics.

## Key Features

- **Simplified ETL Pipeline**: Direct transformation from Synthea CSV files to OMOP CDM tables
- **Optimized for Performance**: Batch processing, parallel execution, and efficient PostgreSQL operations
- **UUID-to-Integer Mapping**: Automatic conversion of Synthea's UUID identifiers to OMOP's integer IDs
- **Progress Tracking**: Detailed progress reporting and checkpoint system
- **Error Handling**: Robust error detection and reporting
- **Flexible Configuration**: Customizable options for different environments and datasets

## Pipeline Architecture

The ETL pipeline consists of the following key steps:

1. **Preprocessing**: Fix malformed CSV files from Synthea
2. **Staging Load**: Load data directly into PostgreSQL staging tables with _raw suffix
3. **Mapping Tables**: Create and populate mapping tables for UUID-to-integer conversion
4. **OMOP Transformation**: Transform staging data to OMOP CDM format

## Recent Improvements

### Simplified ETL Pipeline

The latest version of the pipeline eliminates unnecessary steps:

- **Removed Typing Step**: The staging schema already has appropriate data types for most fields
- **Eliminated Population Schema**: Data now flows directly from staging to OMOP
- **Reduced Disk Space Usage**: ~50% reduction by eliminating duplicate data storage
- **Improved Processing Efficiency**: Fewer steps means faster processing and less complexity

### UUID-to-Integer Mapping

- Implemented a mapping approach for converting Synthea's UUID-format IDs to OMOP's integer IDs
- Created mapping tables (person_map, visit_map, etc.) with PostgreSQL sequences
- Ensures referential integrity throughout the ETL process

### Batch Processing for Large Datasets

- Implemented batch processing for all database operations
- Added detailed progress tracking for each batch
- Commits after each batch to prevent transaction log buildup
- Ensures proper error handling and connection cleanup

### Measurement and Observation Handling

- Implemented a two-phase approach to properly separate measurements and observations
- Phase 1: Load all data into the measurement table first
- Phase 2: Identify and transfer non-numeric values to the observation table
- Ensures proper adherence to OMOP CDM guidelines

## Getting Started

### Prerequisites

- PostgreSQL database (version 12+)
- Python 3.6+
- Synthea-generated CSV files
- Required Python packages: `psycopg2`, `psycopg2-binary`

### Installation

1. Clone this repository:
   ```bash
   git clone https://github.com/acumenus/Synthea2OMOP-ETL.git
   cd Synthea2OMOP-ETL
   ```

2. Set up environment variables (or create a .env file):
   ```bash
   export DB_HOST=localhost
   export DB_PORT=5432
   export DB_NAME=synthea
   export DB_USER=postgres
   export DB_PASSWORD=postgres
   export SYNTHEA_DATA_DIR=/path/to/synthea/output
   ```

### Usage

#### Running the Simplified ETL Pipeline

```bash
./bash/run_simplified_etl.sh
```

Options:
- `--force-restart`: Force restart of all ETL steps
- `--force-load`: Force reload of data even if tables exist
- `--no-progress-bar`: Disable progress bars
- `-v, --verbose`: Enable verbose output

#### Running the Complete ETL Pipeline (Legacy)

```bash
./bash/run_complete_etl_with_unified_progress.sh
```

Options:
- `--input-dir DIR`: Directory with Synthea output files
- `--processed-dir DIR`: Directory for preprocessed files
- `--overwrite-processed`: Overwrite existing preprocessed files
- `--debug`: Enable debug logging
- `--force-load`: Force overwrite of existing database tables
- `--max-workers N`: Maximum number of parallel workers

## Performance Optimization

The project includes several optimizations for handling large datasets:

1. **Direct Import Pipeline**: Transforms Synthea CSV data directly to OMOP CDM tables
2. **Parallel Processing**: Concurrent execution of independent ETL steps
3. **Database Connection Pooling**: Efficient management of database connections
4. **Bulk Loading**: Using PostgreSQL's COPY command for maximum efficiency
5. **PostgreSQL Optimization**: Tuned configuration parameters for ETL performance
6. **Memory Management**: Efficient handling of large datasets without excessive memory usage

## Troubleshooting

### Common Issues

1. **Preprocessing fails**: Check the logs in the `logs` directory for details
2. **Database loading fails**: Verify database connection parameters and permissions
3. **Type conversion errors**: May be due to unexpected data formats in source files
4. **Memory issues**: Reduce the number of parallel workers or batch size

### Debug Mode

Enable debug mode for more detailed logging:

```bash
./bash/run_simplified_etl.sh -v
```

## Project Structure

```
Synthea2OMOP-ETL/
├── bash/                  # Shell scripts for running the ETL pipeline
├── data/                  # Directory for input and processed data
├── docs/                  # Documentation files
├── logs/                  # Log files
├── python/                # Python scripts for ETL processing
├── scripts/               # Helper scripts
├── sql/                   # SQL scripts for database operations
│   ├── ddl/               # Data definition language scripts
│   ├── etl/               # ETL transformation scripts
│   └── vocabulary/        # OMOP vocabulary loading scripts
└── README.md              # This file
```

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

This project is licensed under the Apache License 2.0 - see the LICENSE file for details.

## Acknowledgments

- [Synthea](https://github.com/synthetichealth/synthea) for generating synthetic patient data
- [OHDSI](https://www.ohdsi.org/) for the OMOP Common Data Model
- All contributors to this project
